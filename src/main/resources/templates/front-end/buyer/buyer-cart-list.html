<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<th:block th:insert="~{/fragment-head}"></th:block>


</head>
<body>
	<!-- ======= Header ======= -->
	<header class="fixed-top">
		<th:block th:insert="~{/front-end/buyer/header-buyer}"></th:block>
	</header>

	<!-- ======= Sidebar ======= -->
	<aside th:replace="@{front-end/buyer/aside-buyer}"></aside>

	<!-- ======= Main ======= -->
	<main class="main main-layout-seller">
		<div class="container-fluid seller-container">
			<h1>我的購物車</h1>

			<div class="container mt-3 container-list-custom">
				<div class="row sec-row-custom">
					<div class="col-1">
						<input class="form-check-input cart-overall-click" type="checkbox"
							value="" aria-label="Checkbox for following text input" />
					</div>
					<div class="col-3">商品圖片</div>
					<div class="col-2">商品名稱</div>
					<div class="col-2 d-flex justify-content-end">購買數量</div>
					<div class="col-2 d-flex justify-content-end">單個價格</div>
					<div class="col d-flex justify-content-center">操作</div>
				</div>

				<!-- 如果你購物車沒有東西, 顯示這裡 -->
				<div class="col-12" th:if="${#maps.isEmpty(cartClassfi) }">
				<a href="/">你的購物車是空的，馬上去逛逛吧~</a></div>

                <!-- 先進行大迴圈, 從redis 取出資料 -->
				<section class="cart-seller mt-3" 
				    th:each="sellerCompany : ${cartClassfi}">
					<div class="row header-row-custom">
						<div class="col-auto px-0">
							<input class="form-check-input cart-header-click" type="checkbox"
								value="" aria-label="Checkbox for following text input" />
						</div>
						<div class="col">
							賣家名稱&nbsp;&nbsp;&nbsp;<span class="sellerName">
							<b th:text="${sellerCompany.key}"></b>
							</span>
						</div>
					</div>

					<!-- 後套入小迴圈的資料 -->
					<div class="row item-row-custom"
					     th:each="productVO : ${cartClassfi[ sellerCompany.key ]}">
						<div class="col-1 px-0">
							<input class="form-check-input cart-item-click" type="checkbox"
								value="" aria-label="Checkbox for following text input" />
						</div>
						<div class="col-3">
							<img th:src="@{/front/buyer/collection/DBGifReader} + '?productId=' + ${productVO.productId}" 
							     width="100px"  alt="" srcset="" />
						</div>
						<div class="col-2"
						     th:text="${productVO.productName}">商品名稱</div>
						<div class="col-2 d-flex justify-content-end cart-qty">購買數量</div>
						<div class="col-2 d-flex justify-content-end cart-price"
						     th:text="${productVO.price}">商品金額</div>
						<div
							class="col d-flex flex-column align-items-center justify-content-center">
							<button class="product btn-func">查看商品</button>
							<button class="btn-func cart-item-delete">移出購物車</button>
						</div>
					</div>
				</section>

			</div>

			<section class="cart-pay-sticky px-5 mt-5">
				<div class="row d-flex justify-content-end align-items-center">
					<div class="col-1-5">結帳 NT$</div>
					<div class="col-2 cart-payment d-flex justify-content-end">
						<span class="payment">600</span>元
					</div>
					<div class="col-auto">
						<div class="btn btn-primary">去買單</div>
					</div>
				</div>
			</section>

			<!-- Content for All Orders Tab -->
		</div>
	</main>

	<!-- End Main -->

	<!-- ======= Footer ======= -->
	<footer class="footer footer-layout"> </footer>
	<!-- End Footer -->

	<!-- Local JS File -->
	<div th:replace="fragment-js"></div>

	<script>
		document
				.addEventListener(
						"DOMContentLoaded",
						function() {
							init();

							function init() {
								updateCheckoutAmount();
							}

							function handlesectionClick(event) {
								const currentClicked = this.checked;
								console.log(currentClicked);

								const overallSection = this
										.closest(".container-list-custom");
								const headerClicks = overallSection
										.querySelectorAll(".cart-header-click");

								headerClicks
										.forEach(
												function(headerClick) {
													if (currentClicked !== headerClick.checked) {
														headerClick.click();
													}
												}, this);
							}

							function handleItemClick(event) {
								event.stopPropagation();

								const secCart = this.closest(".cart-seller");
								const isAllItemClicked = secCart
										.querySelectorAll(".item-row-custom input:checked").length === secCart
										.querySelectorAll(".item-row-custom").length;

								secCart.querySelector(".cart-header-click").checked = isAllItemClicked;
								updateCheckoutAmount();
							}

							function handleHeaderClick(event) {
								event.stopPropagation();

								const secCart = this.closest(".cart-seller");
								const subClicks = secCart
										.querySelectorAll(".item-row-custom input");

								subClicks.forEach(function(subClick) {
									subClick.checked = this.checked;
								}, this);

								// Process overall click
								const overallSection = this
										.closest(".container-list-custom");
								const isAllHeaderClicked = overallSection
										.querySelectorAll(".header-row-custom input:checked").length === overallSection
										.querySelectorAll(".header-row-custom").length;

								overallSection
										.querySelector(".cart-overall-click").checked = isAllHeaderClicked;
								updateCheckoutAmount();
							}

							const itemClickEls = document
									.querySelectorAll(".cart-item-click");
							const headerClickEls = document
									.querySelectorAll(".cart-header-click");
							const sectionClickEl = document
									.querySelector(".cart-overall-click");

							itemClickEls.forEach(function(itemClickEl) {
								itemClickEl.addEventListener("click",
										handleItemClick);
							});

							headerClickEls.forEach(function(headerClickEl) {
								headerClickEl.addEventListener("click",
										handleHeaderClick);
							});

							sectionClickEl.addEventListener("click",
									handlesectionClick);

							function handleItemDelete(event) {
								event.stopPropagation();

								const rowItem = this
										.closest(".item-row-custom");

								if (!rowItem)
									return;

								const secCart = rowItem.parentElement;

								rowItem.remove();

								if (secCart
										&& secCart
												.querySelectorAll(".item-row-custom").length === 0) {
									secCart.remove();
								}

								updateCheckoutAmount();
							}

							const itemDeleteEls = document
									.querySelectorAll(".cart-item-delete");

							itemDeleteEls.forEach(function(itemDeleteEl) {
								itemDeleteEl.addEventListener("click",
										handleItemDelete);
							});

							function updateCheckoutAmount() {
								let totalAmount = 0;

								// Iterate over all checked items
								document
										.querySelectorAll(
												".cart-item-click:checked")
										.forEach(
												function(item) {
													const rowItem = item
															.closest(".item-row-custom");
													console.log(rowItem);

													if (rowItem) {
														const priceElement = rowItem
																.querySelector(".cart-price");
														const price = parseFloat(priceElement.textContent);
														totalAmount += price;
													}
												});

								// Update the displayed total amount
								const totalAmountElement = document
										.querySelector(".cart-payment .payment");
								totalAmountElement.textContent = totalAmount
										.toFixed(2); // Assuming you want to display with 2 decimal places
							}
						});
	</script>
</body>
</html>
