<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">

<head>
<th:block th:insert="~{/fragment-head}"></th:block>
</head>

<body>
	<!-- ======= Header ======= -->
	<header class="fixed-top">
		<th:block th:insert="~{/front-end/buyer/header-buyer}"></th:block>
	</header>

	<!-- ======= Sidebar ======= -->
	<aside th:replace="@{front-end/buyer/aside-buyer}"></aside>

	<!-- ======= Main ======= -->
	<main class="main main-layout-seller">
		<div class="container-fluid seller-container">
			<h2>結帳</h2>
			<!-- <div class="container mt-3 container-list-custom">
				<div class="row sec-row-custom">
					<div class="col-1">
						<input class="form-check-input cart-overall-click" type="checkbox" value=""
							aria-label="Checkbox for following text input" hidden />
					</div>
					<div class="col-3">商品圖片</div>
					<div class="col-2">商品名稱</div>
					<div class="col-2 d-flex justify-content-end">單個價格</div>
					<div class="col-2 d-flex justify-content-end">購買數量</div>
					<div class="col d-flex justify-content-center">操作</div>
				</div> -->

			<!-- 如果你購物車沒有東西, 顯示這裡 -->
			<div class="col-12" th:if="${#maps.isEmpty(cartClassfi) }">
				<a href="/">你的購物車是空的，馬上去逛逛吧~</a>
			</div>

			<!-- 先進行大迴圈, 從redis 取出資料 -->

			<section class="cart-seller mt-3"
				th:each="sellerCompany : ${cartClassfi}">

				<div class="container mt-3 container-list-custom">

					<div class="row header-row-custom">
						<div class="col-auto px-0">
							<input class="form-check-input cart-header-click" type="checkbox"
								value="" aria-label="Checkbox for following text input" hidden />
						</div>
						<div class="col">
							賣家名稱&nbsp;&nbsp;&nbsp;<span class="sellerName"> <b
								class="cart-sellerId" th:text="${sellerCompany.key}"></b>
							</span> <span> <span class="get_sellerId"
								th:text="${sellerCompany.value.iterator().next().sellerVO.sellerId}"
								hidden></span>
							</span>


						</div>
					</div>




					<div class="row sec-row-custom">
						<div class="col-1">
							<input class="form-check-input cart-overall-click"
								type="checkbox" value=""
								aria-label="Checkbox for following text input" hidden />
						</div>
						<div class="col-3">商品圖片</div>
						<div class="col-2">商品名稱</div>
						<div class="col-2 d-flex justify-content-end">單個價格</div>
						<div class="col-2 d-flex justify-content-end">購買數量</div>
						<!-- <div class="col d-flex justify-content-center">操作</div> -->
					</div>




					<!-- <div class="row header-row-custom">
						<div class="col-auto px-0">
							<input class="form-check-input cart-header-click" type="checkbox"
								value="" aria-label="Checkbox for following text input" hidden />
						</div>
						<div class="col">
							賣家名稱&nbsp;&nbsp;&nbsp;<span class="sellerName"> <b
								class="cart-sellerId" th:text="${sellerCompany.key}"></b>
							</span>
						</div>
					</div> -->

					<!-- 後套入小迴圈的資料 -->
					<div class="row item-row-custom"
						th:each="cartVO : ${cartClassfi[ sellerCompany.key ]}">
						<div class="col-1 px-0">
							<input class="form-check-input cart-item-click" type="checkbox"
								value="" aria-label="Checkbox for following text input" hidden />
						</div>
						<div class="col-3">
							<img
								th:src="@{/front/buyer/collection/DBGifReader} + '?productId=' + ${cartVO.productVO.productId}"
								width="100px" />
						</div>
						<div class="col-2" th:text="${cartVO.productVO.productName}">商品名稱</div>
						<!--  <div class="col-2 get_sellerId" th:text="${cartVO.sellerVO.sellerId}" >獲取賣家Id</div>  -->
						<div class="col-2 d-flex justify-content-end cart-price"
							th:text="${cartVO.productVO.price}">商品金額</div>
						<div class="col-2 d-flex justify-content-end cart-qty"
							th:text="${cartVO.productNum}">商品數量</div>
						<div class="justify-content-end cart-productId"
							th:text="${cartVO.productVO.productId}" style="display: none">productId</div>
						<div
							class="col d-flex flex-column align-items-center justify-content-center">
							<!-- <button class="product btn-func">更改數量</button> -->
							<!-- <button class="btn-func cart-item-delete" th:data-memberId="9"
								th:data-productId="${cartVO.productVO.productId}"
								th:productId="${cartVO.productVO.productId}"
								onclick="removeOneFromCart(this)">移出購物車</button> -->

						</div>
					</div>

					<div style="margin-top: 30px;"></div>

					<form>
						<div class="accordion" id="accordionExample">
							<div class="accordion-item">
								<h2 class="accordion-header">
									<button class="accordion-button" type="button"
										data-bs-toggle="collapse" data-bs-target="#collapseOne"
										aria-expanded="true" aria-controls="collapseOne"
										style="color: #41464b; background-color: #e2e3e5; border-color: #d3d6d8;">
										收件者資訊</button>
								</h2>
								<div id="collapseOne" class="accordion-collapse collapse show"
									data-bs-parent="#accordionExample">
									<div class="accordion-body">
										<!-- <div class="mb-3 form-check">
										<input type="checkbox" class="form-check-input"
											id="exampleCheck2"> <label class="form-check-label"
											for="exampleCheck2">同會員資訊</label>
									</div> -->
										<div class="row mb-3">
											<label for="inputEmail3" class="col-sm-2 col-form-label">*姓名:</label>
											<div class="col-sm-10">
												<input type="text" class="form-control receiver-input"
													id="inputPassword3" style="width: 30%;" value="金城武">
												<div style="color: red;">*此為必填欄位</div>
											</div>
										</div>
										<div class="row mb-3">
											<label for="inputPassword3" class="col-sm-2 col-form-label ">*手機:</label>
											<div class="col-sm-10">
												<input type="text" class="form-control mobile-input"
													id="inputPassword3" placeholder="09xx000xxx"
													style="width: 30%;" value="0912345678">
											</div>
										</div>
										<div class="row mb-3">
											<label for="inputPassword3" class="col-sm-2 col-form-label">*電子信箱:</label>
											<div class="col-sm-10">
												<input type="text" class="form-control " id="inputPassword3"
													style="width: 30%;" value="edog666@gmail.com">
											</div>
										</div>
										<div class="row mb-3">
											<label for="inputPassword3" class="col-sm-2 col-form-label ">*地址:</label>
											<div class="col-sm-10">
												<input type="text" class="form-control address-input"
													id="inputPassword3" style="width: 30%;" value="直送台北101樓謝謝">
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</form>
			</section>

			<div style="margin-top: 30px;"></div>
			<form>
				<div class="accordion accordion-flush" id="paymentAccordion">
					<div class="accordion-item">
						<h2 class="accordion-header">
							<button class="accordion-button collapsed" type="button"
								data-bs-toggle="collapse" data-bs-target="#paymentCollapse"
								aria-expanded="false" aria-controls="paymentCollapse"
								style="color: #41464b; background-color: #e2e3e5; border-color: #d3d6d8;">
								選擇付款方式</button>
						</h2>
						<div id="paymentCollapse" class="accordion-collapse collapse"
							data-bs-parent="#paymentAccordion">
							<div class="accordion-body">
								<div class="form-check-group">
									<div class="mb-3 form-check">
										<input type="radio" class="form-check-input"
											name="paymentMethod" id="creditCard" checked> <label
											class="form-check-label" for="creditCard">信用卡</label>
									</div>
									<div class="mb-3 form-check">
										<input type="radio" class="form-check-input"
											name="paymentMethod" id="atm"> <label
											class="form-check-label" for="atm">ATM轉帳</label>
									</div>
								</div>
							</div>

						</div>

					</div>
				</div>
			</form>
			<div style="margin-top: 30px;"></div>
			<form>
				<div class="accordion accordion-flush" id="deliveryAccordion">
					<div class="accordion-item">
						<h2 class="accordion-header">
							<button class="accordion-button collapsed" type="button"
								data-bs-toggle="collapse" data-bs-target="#deliveryCollapse"
								aria-expanded="false" aria-controls="deliveryCollapse"
								style="color: #41464b; background-color: #e2e3e5; border-color: #d3d6d8;">
								選擇取貨方式</button>
						</h2>
						<div id="deliveryCollapse" class="accordion-collapse collapse"
							data-bs-parent="#deliveryAccordion">
							<div class="accordion-body">
								<div class="form-check-group">
									<!-- <div class="mb-3 form-check">
											<input type="radio" class="form-check-input"
												name="deliveryMethod" id="convenienceStore"
												value="convenienceStore"> <label
												class="form-check-label" for="convenienceStore">超商結帳</label>
										</div> -->
									<div class="mb-3 form-check">
										<input type="radio" class="form-check-input"
											name="deliveryMethod" id="homeDelivery" value="homeDelivery"
											checked> <label class="form-check-label"
											for="homeDelivery">宅配到府</label>
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>
			</form>
		</div>

		<section class="cart-pay-sticky px-5 mt-5">


			<div class="row d-flex justify-content-end align-items-center">
				<div class="col-1-5">商品金額 NT$</div>
				<div class="col-2 product-total d-flex justify-content-end">
					<span class="total">0</span>元
				</div>
			</div>
			<div class="row d-flex justify-content-end align-items-center">
				<div class="col-1-5">運費 NT$</div>
				<div class="col-2 shipping-fee d-flex justify-content-end">
					<span class="fee">0</span>元
				</div>
			</div>
			<div class="row d-flex justify-content-end align-items-center">
				<div class="col-1-5">結帳 NT$</div>
				<div class="col-2 cart-payment d-flex justify-content-end">
					<span class="payment">0</span>元
				</div>
			</div>

			<div class="row justify-content-end">
				<div class="col-auto">
					<button class="btn btn-primary" id="checkout-btn">去買單</button>
				</div>
			</div>


			<!-- 
			<div class="row d-flex justify-content-end align-items-center">
    <div class="col-1-5">運費 NT$</div>
    <div class="col-2 shipping-fee d-flex justify-content-end">
        <span class="fee">0</span>元
    </div>
</div>
<div class="row d-flex justify-content-end align-items-center">
    <div class="col-1-5">合計 NT$</div>
    <div class="col-2 cart-payment d-flex justify-content-end">
        <span class="payment">600</span>元
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" id="checkout-btn">去買單</button>
    </div>
</div>
			 -->








			<!-- <div class="row d-flex justify-content-end align-items-center">
					<div class="col-1-5">結帳 NT$</div>
					<div class="col-2 cart-payment d-flex justify-content-end">
						<span class="payment">600</span>元
					</div>
					<div class="col-auto">
						<button class="btn btn-primary" id="checkout-btn">去買單</button>
					</div> -->




			<!-- <script>
						$(document).ready(function () {
							$('#checkout-btn').click(function () {
								console.log("按鈕有綁到JS Event");

								let selectedProductsMap = new Map();

								// 將選取的商品編號封裝成資料
								selectedProductsMap = collectSelectedProducts();
								console.log(selectedProductsMap);
								const obj = Object.fromEntries(selectedProductsMap);

								// 将普通对象转换为JSON字符串
								const selectedProductsJsonStr = JSON.stringify(obj);

								// console.log(jsonString);

							
								let url = window.location.protocol + '//' + window.location.hostname + ':' + window.location.port + '/front/buyer/order_checkout';
								let urlReturn = window.location.protocol + '//' + window.location.hostname + ':' + window.location.port + '/';

								fetch((url), {
									method: "POST",
									header: {
										'Content-Type': 'application/json'
										// 如果還有其他的 headers，請在這裡添加
									},
									body: selectedProductsJsonStr
								}).then(response => {

									return response.text();
								}).then((dataBeforeParsed) => {
									console.log(dataBeforeParsed);
									console.log();
									const dataAfterParsed = JSON.parse(dataBeforeParsed);
									console.log(dataAfterParsed); // 此处是正确的写法
									if (parseInt(dataAfterParsed.status) !== 200) {
										alert(dataAfterParsed.msg);
									} else {
										console.log('成功:', dataAfterParsed.msg);
										window.location.href = urlReturn;
									}
								}).catch(error => {
									// 在這裡處理錯誤情況

								});

							});
						});

						function collectSelectedProducts() {

							let selectedProductsMap = new Map();

							// 遍歷每個選中的項目
							document.querySelectorAll(".cart-item-click:checked").forEach((element) => {
								let sellerName = element.closest(".cart-seller").querySelector(".cart-sellerId").textContent;
								let productId = parseInt(element.closest('.item-row-custom').querySelector('.cart-productId').textContent);
								var productQty = parseInt(element.closest('.item-row-custom').querySelector('.cart-qty').textContent);

								if (selectedProductsMap.has(sellerName)) {
									selectedProductsMap.get(sellerName).push({ "productId": productId, "productQty": productQty });
								} else {
									selectedProductsMap.set(sellerName, [{ "productId": productId, "productQty": productQty }]);
								}
							});
							selectedProductsMap.forEach((value, key) => {
								console.log(key);
							});

							return selectedProductsMap;

						}
					</script> -->


			<script>
    $(document).ready(function() {
        // 綁定提交按鈕事件
        $('#checkout-btn').click(function(event) {
            event.preventDefault(); // 阻止按鈕的默認提交行為
            
            // 初始化購物車數據對象
            let shoppingCartDTO = {
                carts: []
            };

            // 假設你已經有了一種方式來區分不同的賣家和它們的產品信息
            // 以下是一個示例過程，你需要根據自己的HTML結構進行調整
            
            // 遍歷每個賣家
            $('.cart-seller').each(function() {
                let sellerId = $(this).find('.get_sellerId').text(); // 假設賣家ID儲存在這裡
                let receiver = $(this).find('.receiver-input').val(); // 收件人姓名輸入框的class
                let mobile = $(this).find('.mobile-input').val(); // 收件人手機輸入框的class
                let contactAddress = $(this).find('.address-input').val(); // 收件地址輸入框的class
                
              /*   alert(receiver);
                alert(mobile); */
               /*  alert(contactAddress); */
                
                // 組裝每個賣家的產品信息
                let products = [];
                $(this).find('.item-row-custom').each(function() {
                    let productId = $(this).find('.cart-productId').text();
                    let quantity = $(this).find('.cart-qty').text();
                    products.push({
                        productId: parseInt(productId),
                        quantity: parseInt(quantity)
                    });
                });

                // 將賣家信息添加到購物車數據對象
                shoppingCartDTO.carts.push({
                    sellerId: parseInt(sellerId),
                    receiverInfo: {
                        receiver: receiver,
                        mobile: mobile,
                        contactAddress: contactAddress
                    },
                    products: products
                });
            });
            
         // 在发送 POST 请求之前打印 shoppingCartDTO 的 JSON 字符串
           /*  console.log(JSON.stringify(shoppingCartDTO)); */

            // 使用fetch發送POST請求
            fetch('create_orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(shoppingCartDTO)
            })
            .then(response => response.json())
            
            .then(data => {
  							  console.log('Success:', data);  //data = "message", "Orders created successfully."
						   
  							  
  						     // 在这里处理成功的消息
						    // 这里你可以根据情况做一些操作，比如显示成功的提示信息等等
						    // 如果需要跳转页面，可以在这里执行跳转操作
  							window.location.href = '/';
				})
			.catch(error => {
			    console.error('Error:', error);
			    // 在这里处理错误，比如显示错误信息给用户
			});
            
            
        });
    });
</script>


		</section>

		<!-- Content for All Orders Tab -->
		<!-- </div> -->
	</main>

	<!-- End Main -->

	<!-- ======= Footer ======= -->
	<footer class="footer footer-layout"> </footer>
	<!-- End Footer -->

	<!-- Local JS File -->
	<div th:replace="fragment-js"></div>

	<script>
		document
			.addEventListener(
				"DOMContentLoaded",
				function () {
					init();

					function init() {
						updateCheckoutAmount();
					}

					function handlesectionClick(event) {
						const currentClicked = this.checked;
						console.log(currentClicked);

						const overallSection = this
							.closest(".container-list-custom");
						const headerClicks = overallSection
							.querySelectorAll(".cart-header-click");

						headerClicks
							.forEach(
								function (headerClick) {
									if (currentClicked !== headerClick.checked) {
										headerClick.click();
									}
								}, this);
					}

					function handleItemClick(event) {
						event.stopPropagation();

						const secCart = this.closest(".cart-seller");
						const isAllItemClicked = secCart
							.querySelectorAll(".item-row-custom input:checked").length === secCart
								.querySelectorAll(".item-row-custom").length;

						secCart.querySelector(".cart-header-click").checked = isAllItemClicked;
						updateCheckoutAmount();
					}

					function handleHeaderClick(event) {
						event.stopPropagation();

						const secCart = this.closest(".cart-seller");
						const subClicks = secCart
							.querySelectorAll(".item-row-custom input");

						subClicks.forEach(function (subClick) {
							subClick.checked = this.checked;
						}, this);

						// Process overall click
						const overallSection = this
							.closest(".container-list-custom");
						const isAllHeaderClicked = overallSection
							.querySelectorAll(".header-row-custom input:checked").length === overallSection
								.querySelectorAll(".header-row-custom").length;

						overallSection
							.querySelector(".cart-overall-click").checked = isAllHeaderClicked;
						updateCheckoutAmount();
					}

					const itemClickEls = document
						.querySelectorAll(".cart-item-click");
					const headerClickEls = document
						.querySelectorAll(".cart-header-click");
					const sectionClickEl = document
						.querySelector(".cart-overall-click");

					itemClickEls.forEach(function (itemClickEl) {
						itemClickEl.addEventListener("click",
							handleItemClick);
					});

					headerClickEls.forEach(function (headerClickEl) {
						headerClickEl.addEventListener("click",
							handleHeaderClick);
					});

					sectionClickEl.addEventListener("click",
						handlesectionClick);

					function handleItemDelete(event) {
						event.stopPropagation();

						const rowItem = this
							.closest(".item-row-custom");

						if (!rowItem)
							return;

						const secCart = rowItem.parentElement;

						rowItem.remove();

						if (secCart
							&& secCart
								.querySelectorAll(".item-row-custom").length === 0) {
							secCart.remove();
						}

						updateCheckoutAmount();
					}

					const itemDeleteEls = document
						.querySelectorAll(".cart-item-delete");

					itemDeleteEls.forEach(function (itemDeleteEl) {
						itemDeleteEl.addEventListener("click",
							handleItemDelete);
					});
					
					function updateCheckoutAmount() {
				        let totalProductAmount = 0; // 用于存储商品总金额
				        let totalShippingFee = 0; // 用于存储总的运费
				        let totalAmount = 0; // 总金额，包括运费

				        // 遍历所有商品行
				        document.querySelectorAll(".cart-seller").forEach(function (seller) {
				            let sellerProductTotal = 0; // 单个卖家的商品总金额
				            seller.querySelectorAll(".item-row-custom").forEach(function (item) {
				                const priceElement = item.querySelector(".cart-price");
				                const price = parseFloat(priceElement.textContent);

				                const qtyElement = item.querySelector(".cart-qty");
				                const qty = parseFloat(qtyElement.textContent);

				                sellerProductTotal += (price * qty);
				            });

				            totalProductAmount += sellerProductTotal; // 累加到商品总金额

				            // 判断是否需要加运费
				            let shippingFee = 0;
				            if (sellerProductTotal < 999) {
				                shippingFee = 70; // 如果单个卖家的商品总金额没有超过999，加上运费70元
				                totalShippingFee += shippingFee; // 累加到总的运费
				            }
				        });

				        totalAmount = totalProductAmount + totalShippingFee; // 总金额等于商品金额加上运费

				        // 更新显示的商品金额、运费和总金额
				        document.querySelector(".product-total .total").textContent = totalProductAmount.toFixed(0);
				        document.querySelector(".shipping-fee .fee").textContent = totalShippingFee.toFixed(0);
				        document.querySelector(".cart-payment .payment").textContent = totalAmount.toFixed(0);
				    }
					
					/* function updateCheckoutAmount() {
				        let totalAmount = 0;
				        let totalShippingFee = 0; // 用于存储总的运费
				        const sellerTotals = new Map(); // 用于存储每个卖家的订单总金额

				        // 遍历所有商品行
				        document.querySelectorAll(".cart-seller").forEach(function (seller) {
				            let sellerTotal = 0; // 单个卖家的订单总金额
				            seller.querySelectorAll(".item-row-custom").forEach(function (item) {
				                const priceElement = item.querySelector(".cart-price");
				                const price = parseFloat(priceElement.textContent);

				                const qtyElement = item.querySelector(".cart-qty");
				                const qty = parseFloat(qtyElement.textContent);

				                sellerTotal += (price * qty);
				            });

				            let shippingFee = 0;
				            if (sellerTotal < 999) {
				                shippingFee = 70; // 如果单个卖家的订单总金额没有超过999，加上运费70元
				                totalShippingFee += shippingFee; // 累加到总的运费
				            }

				            // 存储每个卖家的总金额，包括运费
				            const sellerId = seller.querySelector(".cart-sellerId").textContent;
				            sellerTotals.set(sellerId, sellerTotal + shippingFee);

				            totalAmount += sellerTotal + shippingFee; // 累加到总金额，包括运费
				        });

				        // 更新显示的总金额和运费
				        const totalAmountElement = document.querySelector(".cart-payment .payment");
				        totalAmountElement.textContent = totalAmount.toFixed(0);
				        
				        const shippingFeeElement = document.querySelector(".shipping-fee .fee");
				        shippingFeeElement.textContent = totalShippingFee.toFixed(0); // 更新运费显示
				    } */
					
					
						
					
					
					
					
					
					
					
					
					
					
				});
	</script>
</body>

</html>